<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Character Generator - App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/app.html" class="logo">
                    <i class="fas fa-magic"></i>
                    Character Creator
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Features</div>
                    <a href="#" class="nav-item active" data-page="library">
                        <i class="fas fa-images"></i>
                        Character Gallery
                    </a>
                    <a href="#" class="nav-item" data-page="create">
                        <i class="fas fa-palette"></i>
                        Character Creation
                    </a>
                    <a href="#" class="nav-item" data-page="edit">
                        <i class="fas fa-edit"></i>
                        Character Editing
                    </a>
                    <a href="#" class="nav-item" data-page="scenes">
                        <i class="fas fa-film"></i>
                        Scene Builder
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" data-page="profile">
                        <i class="fas fa-user-circle"></i>
                        Profile
                    </a>
                    <a href="#" class="nav-item" data-page="contact">
                        <i class="fas fa-envelope"></i>
                        Contact
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <span id="user-initial">U</span>
                    </div>
                    <div class="user-info">
                        <h4 id="user-name">User</h4>
                        <p id="user-email">user@example.com</p>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="page-title">Character Gallery</h1>
                </div>
                <div class="header-right">
                    <div class="credits-display">
                        <i class="fas fa-coins"></i>
                        <span id="credits-count">0</span> Credits
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Character Library Page -->
                <div id="library-page" class="page-content active">
                    <!-- Hero Banner -->
                    <div class="hero-banner" style="
                        background: var(--gradient-hero);
                        border-radius: var(--radius-lg);
                        padding: 3rem 2rem;
                        text-align: center;
                        color: white;
                        margin-bottom: 3rem;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%), linear-gradient(-45deg, rgba(255,255,255,0.05) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.05) 75%), linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.05) 75%);
                            background-size: 20px 20px;
                            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
                            opacity: 0.3;
                        "></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="
                                display: inline-block;
                                background: rgba(255,255,255,0.2);
                                border-radius: 50%;
                                padding: 1.5rem;
                                margin-bottom: 1.5rem;
                                backdrop-filter: blur(10px);
                            ">
                                <i class="fas fa-magic" style="font-size: 2.5rem;"></i>
                            </div>
                            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                Your Character Collection
                            </h1>
                            <p style="font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                Discover and manage all your AI-generated characters. Each one is unique, crafted with advanced artificial intelligence.
                            </p>
                            <div style="margin-top: 2rem;">
                                <button class="btn" onclick="switchPage('create')" style="
                                    background: rgba(255,255,255,0.2);
                                    color: white;
                                    border: 2px solid rgba(255,255,255,0.3);
                                    padding: 12px 24px;
                                    border-radius: var(--radius);
                                    font-weight: 600;
                                    backdrop-filter: blur(10px);
                                    transition: var(--transition);
                                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                    <i class="fas fa-plus"></i>
                                    Create New Character
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="character-gallery" class="character-gallery">
                        <div class="empty-state">
                            <div style="width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                            <h3 style="color: var(--text-secondary);">Loading your characters...</h3>
                        </div>
                    </div>
                </div>

                <!-- Character Creation Page -->
                <div id="create-page" class="page-content">
                    <!-- Creation Banner -->
                    <div class="creation-banner" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                        border-radius: var(--radius-lg);
                        padding: 2rem;
                        text-align: center;
                        color: white;
                        margin-bottom: 2rem;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
                        "></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="
                                display: inline-block;
                                background: rgba(255,255,255,0.15);
                                border-radius: 50%;
                                padding: 1rem;
                                margin-bottom: 1rem;
                                backdrop-filter: blur(10px);
                            ">
                                <i class="fas fa-palette" style="font-size: 1.8rem;"></i>
                            </div>
                            <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                Create New Character
                            </h2>
                            <p style="opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.2); font-size: 1rem;">
                                Bring your characters to life with natural language descriptions
                            </p>
                        </div>
                    </div>
                    
                    <!-- Split Layout Container -->
                    <div class="character-creator-layout" style="
                        display: grid;
                        grid-template-columns: minmax(400px, 600px) 1fr;
                        gap: 2rem;
                        min-height: 600px;
                        max-width: 1400px;
                        margin: 0 auto;
                    ">
                        <!-- Left Panel - Input Area -->
                        <div class="input-panel" style="
                            background: var(--background);
                            border-radius: var(--radius-lg);
                            padding: 2rem;
                            border: 1px solid var(--border);
                            box-shadow: var(--shadow);
                            display: flex;
                            flex-direction: column;
                        ">
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                    <i class="fas fa-user-edit" style="color: var(--primary); margin-right: 0.5rem;"></i>
                                    Character Details
                                </h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">
                                    Tell us about your character in your own words
                                </p>
                            </div>

                            <!-- Character Name -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Character Name</label>
                                <input type="text" id="character-name" placeholder="Enter your character's name" style="
                                    width: 100%; 
                                    padding: 14px; 
                                    border: 2px solid var(--border); 
                                    border-radius: var(--radius); 
                                    font-size: 15px;
                                    transition: var(--transition);
                                ">
                            </div>

                            <!-- Main Description -->
                            <div style="margin-bottom: 1.5rem; flex: 1;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Character Description</label>
                                <div style="position: relative;">
                                    <textarea id="character-description" placeholder="Describe your character in detail...

Examples:
• A brave female knight with long blonde hair and blue eyes, wearing silver armor
• A mysterious wizard in dark robes with a staff, elderly with a long white beard
• A young adventurer with brown hair, carrying a backpack and wearing leather armor" 
                                    style="
                                        width: 100%; 
                                        padding: 16px; 
                                        border: 2px solid var(--border); 
                                        border-radius: var(--radius); 
                                        font-size: 15px; 
                                        min-height: 180px; 
                                        resize: vertical;
                                        line-height: 1.5;
                                        font-family: inherit;
                                        transition: var(--transition);
                                    "></textarea>
                                    <div style="
                                        position: absolute;
                                        bottom: 12px;
                                        right: 12px;
                                        background: var(--surface);
                                        padding: 4px 8px;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        color: var(--text-muted);
                                    " id="char-count">0 characters</div>
                                </div>
                            </div>

                            <!-- Quick Options -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">Quick Options</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 14px;">Art Style</label>
                                        <select id="character-style" style="
                                            width: 100%; 
                                            padding: 10px; 
                                            border: 2px solid var(--border); 
                                            border-radius: var(--radius); 
                                            font-size: 14px;
                                            background: var(--background);
                                        ">
                                            <option value="">Any Style</option>
                                            <option value="realistic">Realistic</option>
                                            <option value="anime">Anime</option>
                                            <option value="cartoon">Cartoon</option>
                                            <option value="fantasy">Fantasy</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 14px;">Gender</label>
                                        <select id="character-gender" style="
                                            width: 100%; 
                                            padding: 10px; 
                                            border: 2px solid var(--border); 
                                            border-radius: var(--radius); 
                                            font-size: 14px;
                                            background: var(--background);
                                        ">
                                            <option value="">Any Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="non-binary">Non-binary</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <button id="optimize-prompt-btn" class="btn btn-primary" onclick="generateCharacter()" style="
                                padding: 16px 24px;
                                font-size: 16px;
                                font-weight: 600;
                                width: 100%;
                                margin-top: auto;
                            ">
                                <i class="fas fa-magic"></i>
                                Optimize Prompt
                            </button>
                        </div>

                        <!-- Right Panel - Preview Area -->
                        <div class="preview-panel" style="
                            background: var(--background);
                            border-radius: var(--radius-lg);
                            padding: 2rem;
                            border: 1px solid var(--border);
                            box-shadow: var(--shadow);
                            display: flex;
                            flex-direction: column;
                        ">
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                    <i class="fas fa-eye" style="color: var(--primary); margin-right: 0.5rem;"></i>
                                    Character Preview
                                </h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">
                                    Your generated character will appear here
                                </p>
                            </div>

                            <!-- Preview Content -->
                            <div id="character-preview" style="
                                flex: 1;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                min-height: 400px;
                                background: var(--surface);
                                border-radius: var(--radius);
                                border: 2px dashed var(--border);
                                position: relative;
                            ">
                                <!-- Empty State -->
                                <div id="preview-empty" style="text-align: center; color: var(--text-muted);">
                                    <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">No Character Yet</h4>
                                    <p style="font-size: 14px;">Fill in the details and generate your character</p>
                                </div>

                                <!-- Prompt Optimization Display -->
                                <div id="prompt-optimization" style="display: none; width: 100%;">
                                    <div style="
                                        background: var(--surface);
                                        border: 1px solid var(--border);
                                        border-radius: var(--radius);
                                        padding: 1rem;
                                        margin-bottom: 1rem;
                                    ">
                                        <h5 style="margin-bottom: 0.75rem; color: var(--text-primary); font-size: 0.9rem;">
                                            <i class="fas fa-lightbulb" style="color: var(--warning); margin-right: 0.5rem;"></i>
                                            Optimized Prompt (Click to Edit)
                                        </h5>
                                        <textarea id="optimized-prompt" style="
                                            width: 100%;
                                            background: var(--background);
                                            padding: 0.75rem;
                                            border-radius: 6px;
                                            font-size: 13px;
                                            line-height: 1.4;
                                            color: var(--text-secondary);
                                            border: 2px solid var(--border);
                                            margin-bottom: 0.75rem;
                                            min-height: 120px;
                                            resize: vertical;
                                            font-family: inherit;
                                        "></textarea>
                                        <div id="prompt-reasoning" style="
                                            font-size: 12px;
                                            color: var(--text-muted);
                                            font-style: italic;
                                            margin-bottom: 0.75rem;
                                        "></div>
                                    </div>

                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button id="generate-image-btn" class="btn btn-primary btn-sm" onclick="generateWithOptimizedPrompt()">
                                            <i class="fas fa-magic"></i> Generate Image
                                        </button>
                                        <button id="back-to-preview-btn" class="btn btn-secondary btn-sm" onclick="backToCharacterPreview()" style="display: none;">
                                            <i class="fas fa-arrow-left"></i> Back to Preview
                                        </button>
                                    </div>
                                </div>

                                <!-- Direct Prompt Editing -->
                                <div id="direct-prompt-editing" style="display: none; width: 100%;">
                                    <div style="
                                        background: var(--surface);
                                        border: 1px solid var(--border);
                                        border-radius: var(--radius);
                                        padding: 1rem;
                                        margin-bottom: 1rem;
                                    ">
                                        <h5 style="margin-bottom: 0.75rem; color: var(--text-primary); font-size: 0.9rem;">
                                            <i class="fas fa-edit" style="color: var(--primary); margin-right: 0.5rem;"></i>
                                            Edit Prompt
                                        </h5>
                                        <textarea id="direct-prompt-editor" 
                                        style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 2px solid var(--border);
                                            border-radius: var(--radius);
                                            font-size: 14px;
                                            min-height: 120px;
                                            resize: vertical;
                                            font-family: inherit;
                                        "></textarea>
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button id="generate-edited-image-btn" class="btn btn-primary btn-sm" onclick="generateWithEditedPrompt()">
                                            <i class="fas fa-magic"></i> Generate Image
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="cancelDirectEditing()">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </div>

                                <!-- Generated Character Display -->
                                <div id="preview-character" style="display: none; width: 100%;">
                                    <div id="character-image-container" style="
                                        width: 100%;
                                        min-height: 300px;
                                        max-height: 600px;
                                        background: var(--gradient-primary);
                                        border-radius: var(--radius);
                                        margin-bottom: 1rem;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        overflow: hidden;
                                    ">
                                        <div style="color: white; font-size: 1.1rem; font-weight: 600; text-align: center;">
                                            <i class="fas fa-user" style="font-size: 1.8rem; display: block; margin-bottom: 0.5rem;"></i>
                                            Generated Character
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: left;">
                                        <div style="
                                            background: var(--surface);
                                            padding: 1rem;
                                            border-radius: var(--radius);
                                            border: 1px solid var(--border);
                                            margin-bottom: 1rem;
                                        ">
                                            <h4 id="preview-name" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;"></h4>
                                            <p id="preview-description" style="color: var(--text-secondary); font-size: 14px; line-height: 1.4; margin-bottom: 0.75rem;"></p>
                                            
                                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                <span id="preview-style" class="character-tag" style="display: none;"></span>
                                                <span id="preview-gender" class="character-tag" style="display: none;"></span>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button class="btn btn-secondary btn-sm" onclick="modifyCharacter()">
                                                <i class="fas fa-edit"></i> Modify
                                            </button>
                                            <button class="btn btn-secondary btn-sm" onclick="regenerateCharacter()">
                                                <i class="fas fa-redo"></i> Regenerate
                                            </button>
                                            <button class="btn btn-primary btn-sm" onclick="saveCharacter()">
                                                <i class="fas fa-save"></i> Save
                                            </button>
                                            <button class="btn btn-outline btn-sm" onclick="abandonCharacter()">
                                                <i class="fas fa-trash"></i> Abandon
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Layout Styles -->
                    <style>
                        @media (max-width: 768px) {
                            .character-creator-layout {
                                grid-template-columns: 1fr !important;
                                gap: 1rem !important;
                                max-width: 100% !important;
                                margin: 0 !important;
                            }
                        }

                        @media (max-width: 1024px) {
                            .character-creator-layout {
                                grid-template-columns: minmax(350px, 500px) 1fr !important;
                            }
                        }
                        
                        #character-description:focus,
                        #character-name:focus,
                        #character-style:focus,
                        #character-gender:focus {
                            border-color: var(--primary);
                            outline: none;
                            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                        }
                    </style>
                </div>

                <!-- Character Edit Page -->
                <div id="edit-page" class="page-content">
                    <div style="margin-bottom: 2rem;">
                        <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem;">
                            <i class="fas fa-edit" style="color: var(--primary); margin-right: 0.5rem;"></i>
                            Character Editor
                        </h2>
                        <p style="color: var(--text-muted);">Select a character to edit with AI-powered image variations</p>
                    </div>

                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Left: Character Gallery -->
                        <div>
                            <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Your Characters</h3>
                            <div id="edit-character-gallery" class="character-gallery" style="grid-template-columns: 1fr; max-height: 70vh; overflow-y: auto;">
                                <!-- Characters will be loaded here -->
                            </div>
                        </div>

                        <!-- Right: Edit Panel -->
                        <div>
                            <!-- Empty State -->
                            <div id="edit-empty-state" style="
                                background: var(--surface);
                                border: 2px dashed var(--border);
                                border-radius: var(--radius);
                                padding: 3rem;
                                text-align: center;
                                color: var(--text-muted);
                            ">
                                <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h4 style="margin-bottom: 0.5rem;">No Character Selected</h4>
                                <p style="font-size: 14px;">Select a character from the left to start editing</p>
                            </div>

                            <!-- Edit Panel -->
                            <div id="edit-panel" style="display: none;">
                                <!-- Current Character Display -->
                                <div style="
                                    background: var(--surface);
                                    border: 1px solid var(--border);
                                    border-radius: var(--radius);
                                    padding: 1.5rem;
                                    margin-bottom: 1.5rem;
                                ">
                                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Current Character</h3>
                                    <div id="edit-current-image" style="
                                        width: 100%;
                                        height: 300px;
                                        background: var(--gradient-primary);
                                        border-radius: var(--radius);
                                        margin-bottom: 1rem;
                                        overflow: hidden;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    ">
                                        <img id="edit-character-image" style="width: 100%; height: 100%; object-fit: contain;" />
                                    </div>
                                    <h4 id="edit-character-name" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;"></h4>
                                    <p id="edit-character-description" style="color: var(--text-secondary); font-size: 14px;"></p>
                                </div>

                                <!-- Edit Controls -->
                                <div style="
                                    background: var(--surface);
                                    border: 1px solid var(--border);
                                    border-radius: var(--radius);
                                    padding: 1.5rem;
                                ">
                                    <!-- Theme Selection -->
                                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(var(--primary-rgb), 0.05); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                                            <i class="fas fa-folder"></i> Select Theme
                                        </label>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <select
                                                id="edit-theme-selector"
                                                style="
                                                    flex: 1;
                                                    padding: 0.5rem;
                                                    border: 1px solid var(--border);
                                                    border-radius: var(--radius);
                                                    background: var(--background);
                                                    color: var(--text-primary);
                                                    font-size: 14px;
                                                "
                                                onchange="onEditThemeSelected()"
                                            >
                                                <option value="">Select a character first...</option>
                                            </select>
                                            <button
                                                class="btn btn-sm btn-outline"
                                                onclick="showEditCreateThemeDialog()"
                                                style="white-space: nowrap; font-size: 13px;"
                                            >
                                                <i class="fas fa-plus"></i> New
                                            </button>
                                        </div>
                                        <div id="edit-theme-info" style="font-size: 12px; color: var(--text-muted); display: none;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span id="edit-theme-variant-count"></span>
                                                <button class="btn btn-sm btn-outline" onclick="editEditTheme()" style="font-size: 11px; padding: 0.25rem 0.5rem;">
                                                    <i class="fas fa-edit"></i> Rename
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">
                                        <i class="fas fa-magic" style="color: var(--primary); margin-right: 0.5rem;"></i>
                                        AI Image Editing
                                    </h3>

                                    <label style="
                                        display: block;
                                        font-weight: 600;
                                        margin-bottom: 0.5rem;
                                        font-size: 14px;
                                    ">Describe Your Changes</label>
                                    <textarea id="edit-prompt" placeholder="E.g., 'Make the character smile', 'Add sunglasses', 'Change to winter clothing', 'Different hairstyle'..." style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid var(--border);
                                        border-radius: var(--radius);
                                        font-size: 14px;
                                        min-height: 120px;
                                        resize: vertical;
                                        font-family: inherit;
                                        margin-bottom: 1rem;
                                    "></textarea>

                                    <button class="btn btn-primary" onclick="applyCharacterEdit()" style="width: 100%;">
                                        <i class="fas fa-wand-magic-sparkles"></i> Generate Variation
                                    </button>
                                </div>

                                <!-- Generated Result -->
                                <div id="edit-result" style="display: none; margin-top: 1.5rem;">
                                    <div style="
                                        background: var(--surface);
                                        border: 1px solid var(--border);
                                        border-radius: var(--radius);
                                        padding: 1.5rem;
                                    ">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h3 style="font-size: 1.2rem; font-weight: 600; margin: 0;">Generated Variations</h3>
                                            <span id="variant-count" style="font-size: 14px; color: var(--text-muted);">0 variants</span>
                                        </div>

                                        <!-- Variants Grid Container -->
                                        <div id="variants-grid" style="
                                            display: grid;
                                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                                            gap: 1rem;
                                            margin-bottom: 1rem;
                                        ">
                                            <!-- Variant cards will be added here dynamically -->
                                        </div>

                                        <p style="font-size: 12px; color: var(--text-muted); text-align: center;">
                                            Saving to theme: <strong id="save-theme-name"></strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scenes Page -->
                <div id="scenes-page" class="page-content">
                    <div class="empty-state">
                        <i class="fas fa-film"></i>
                        <h3>Scene Builder</h3>
                        <p>Select characters to create dynamic scenes</p>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profile-page" class="page-content">
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <span id="profile-initial">U</span>
                            </div>
                            <div class="profile-info">
                                <h2 id="profile-name">Username</h2>
                                <p id="profile-email">user@example.com</p>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="total-characters">0</div>
                                <div class="stat-label">Characters Created</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="total-credits">0</div>
                                <div class="stat-label">Credits Remaining</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="join-days">1</div>
                                <div class="stat-label">Days Joined</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="total-scenes">0</div>
                                <div class="stat-label">Scenes Created</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Page -->
                <div id="contact-page" class="page-content">
                    <div class="profile-section">
                        <div style="max-width: 800px; margin: 0 auto;">
                            <div style="text-align: center; margin-bottom: 3rem;">
                                <div style="
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                    width: 80px;
                                    height: 80px;
                                    background: var(--gradient-primary);
                                    border-radius: 50%;
                                    margin-bottom: 1.5rem;
                                ">
                                    <i class="fas fa-envelope" style="font-size: 2rem; color: white;"></i>
                                </div>
                                <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">Get in Touch</h2>
                                <p style="font-size: 1.1rem; color: var(--text-secondary); line-height: 1.6;">
                                    Have questions, feedback, or need assistance? We'd love to hear from you!
                                </p>
                            </div>

                            <div style="
                                background: var(--surface);
                                border: 1px solid var(--border);
                                border-radius: var(--radius-lg);
                                padding: 2.5rem;
                                text-align: center;
                            ">
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                                        <i class="fas fa-paper-plane" style="color: var(--primary); margin-right: 0.5rem;"></i>
                                        Email Us
                                    </h3>
                                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.95rem;">
                                        Send your message to our support team
                                    </p>
                                    <a href="mailto:1058134934@qq.com" style="
                                        display: inline-flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                        font-size: 1.1rem;
                                        color: var(--primary);
                                        text-decoration: none;
                                        font-weight: 600;
                                        padding: 0.75rem 1.5rem;
                                        background: rgba(var(--primary-rgb), 0.1);
                                        border-radius: var(--radius);
                                        transition: var(--transition);
                                    " onmouseover="this.style.background='rgba(var(--primary-rgb), 0.15)'" onmouseout="this.style.background='rgba(var(--primary-rgb), 0.1)'">
                                        <i class="fas fa-envelope"></i>
                                        1058134934@qq.com
                                    </a>
                                </div>

                                <div style="
                                    padding-top: 2rem;
                                    border-top: 1px solid var(--border);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 0.5rem;
                                        color: var(--text-muted);
                                        font-size: 0.95rem;
                                    ">
                                        <i class="fas fa-clock"></i>
                                        <span>We typically respond within 24-48 hours</span>
                                    </div>
                                </div>
                            </div>

                            <div style="
                                margin-top: 2rem;
                                padding: 1.5rem;
                                background: rgba(var(--primary-rgb), 0.05);
                                border-left: 4px solid var(--primary);
                                border-radius: var(--radius);
                            ">
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1rem;">
                                    <i class="fas fa-info-circle"></i> Note
                                </h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                                    When contacting us, please include as much detail as possible about your inquiry.
                                    This helps us provide you with the best assistance!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); display: flex; align-items: center; gap: 1rem; box-shadow: var(--shadow-xl);">
            <div style="width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s ease-in-out infinite;"></div>
            <span id="loading-text">Processing...</span>
        </div>
    </div>

    <!-- JavaScript Modules - Load in order -->
    <!-- Auth and Credits Modules -->
    <script src="/modules/auth.js"></script>
    <script src="/modules/credits.js"></script>

    <!-- Application Scripts -->
    <script src="/js/common.js"></script>
    <script src="/js/themes.js"></script>
    <script src="/js/gallery.js"></script>
    <script src="/js/creation.js"></script>
    <script src="/js/button-credits.js"></script>

    <!-- Initialize Credits Display -->
    <script>
        // Update credits display when balance changes
        window.CreditsModule.onBalanceChange((data) => {
            const creditsCountElement = document.getElementById('credits-count');
            const totalCreditsElement = document.getElementById('total-credits');

            if (creditsCountElement) {
                creditsCountElement.textContent = data.balance;
            }
            if (totalCreditsElement) {
                totalCreditsElement.textContent = data.balance;
            }
        });

        // Check authentication and load credits
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('[APP] ===== DOMContentLoaded START =====');

            try {
                // Get Bearer token from storage
                const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                console.log('[APP] Token from storage:', token ? `exists (${token.substring(0, 20)}...)` : 'NONE');

                if (!token) {
                    console.error('[APP] ❌ NO TOKEN - redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }

                // Verify token with /auth/me endpoint
                console.log('[APP] Calling /api/v1/auth/me...');
                const response = await fetch('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('[APP] Response status:', response.status, response.statusText);

                // Only clear token on explicit 401 Unauthorized
                if (response.status === 401) {
                    console.error('[APP] ❌ 401 UNAUTHORIZED - Invalid token, clearing and redirecting');
                    localStorage.removeItem('auth_token');
                    sessionStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('user');
                    window.location.href = '/login.html';
                    return;
                }

                // For other errors (network issues, 500, etc), don't clear token
                if (!response.ok) {
                    console.error('[APP] ❌ RESPONSE ERROR - Status:', response.status, '(Not clearing token - may be temporary network issue)');
                    // Still try to use cached user data if available
                    const cachedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                    if (cachedUser) {
                        try {
                            const user = JSON.parse(cachedUser);
                            console.log('[APP] Using cached user data:', user.email);
                            document.getElementById('user-name').textContent = user.name || 'User';
                            document.getElementById('user-email').textContent = user.email || '';
                            document.getElementById('user-initial').textContent = (user.name || 'U')[0].toUpperCase();
                        } catch (e) {
                            console.error('[APP] Failed to parse cached user:', e);
                        }
                    }
                    return;
                }

                const result = await response.json();
                console.log('[APP] Response data:', result);

                if (result.success && result.data.user) {
                    console.log('[APP] ✅ AUTH SUCCESS - User:', result.data.user.email);

                    // User is authenticated
                    const user = result.data.user;

                    // Update user info in the UI (sidebar)
                    document.getElementById('user-name').textContent = user.name || 'User';
                    document.getElementById('user-email').textContent = user.email || '';
                    document.getElementById('user-initial').textContent = (user.name || 'U')[0].toUpperCase();

                    // Update Profile page
                    document.getElementById('profile-name').textContent = user.name || 'User';
                    document.getElementById('profile-email').textContent = user.email || '';
                    document.getElementById('profile-initial').textContent = (user.name || 'U')[0].toUpperCase();

                    // Calculate days joined
                    if (user.createdAt) {
                        const createdDate = new Date(user.createdAt);
                        const now = new Date();
                        const diffTime = Math.abs(now - createdDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        document.getElementById('join-days').textContent = diffDays;
                    }

                    // Start polling for credit updates
                    window.CreditsModule.startPolling(30000); // Poll every 30 seconds

                    // Load initial balance
                    const balance = await window.CreditsModule.getBalance();
                    if (balance) {
                        document.getElementById('credits-count').textContent = balance.balance;
                        document.getElementById('total-credits').textContent = balance.balance;
                    }

                    // Load API costs for button display
                    await window.CreditsModule.loadCosts();

                    // Update buttons with credit costs after costs are loaded
                    if (window.ButtonCredits) {
                        window.ButtonCredits.initializeButtonCosts();
                    }

                    // Load characters for gallery
                    console.log('[APP] Loading characters...');
                    if (typeof loadCharacters === 'function') {
                        characters = await loadCharacters();

                        // Update total characters count in Profile page
                        if (characters && Array.isArray(characters)) {
                            document.getElementById('total-characters').textContent = characters.length;
                        }

                        if (typeof updateCharacterGallery === 'function') {
                            await updateCharacterGallery();
                        }
                    }
                } else {
                    console.error('[APP] ❌ INVALID RESPONSE - Result:', result);
                    // Only clear on explicit authentication failure
                    if (result.error?.code === 'UNAUTHORIZED') {
                        console.error('[APP] Clearing token and redirecting');
                        localStorage.removeItem('auth_token');
                        sessionStorage.removeItem('auth_token');
                        localStorage.removeItem('user');
                        sessionStorage.removeItem('user');
                        window.location.href = '/login.html';
                    }
                }
            } catch (error) {
                console.error('[APP] ❌ EXCEPTION:', error);
                console.error('[APP] Error stack:', error.stack);
                // Don't clear token on network errors - may be temporary
                console.error('[APP] Network or other error - NOT clearing token (may be temporary)');

                // Try to use cached user data
                const cachedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                if (cachedUser) {
                    try {
                        const user = JSON.parse(cachedUser);
                        console.log('[APP] Using cached user data:', user.email);
                        document.getElementById('user-name').textContent = user.name || 'User';
                        document.getElementById('user-email').textContent = user.email || '';
                        document.getElementById('user-initial').textContent = (user.name || 'U')[0].toUpperCase();
                    } catch (e) {
                        console.error('[APP] Failed to parse cached user:', e);
                    }
                }
            }

            console.log('[APP] ===== DOMContentLoaded END =====');
        });

        // Stop polling when user logs out
        window.addEventListener('auth:logout', () => {
            window.CreditsModule.stopPolling();
            window.location.href = '/login.html';
        });
    </script>
</body>
</html>
